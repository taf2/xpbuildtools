<html>
<head>
	<style type="text/css">/*<![CDATA[ */
		div ul.hidden {display:none;}
		#decoded.show ul.hidden {display:block;}
		#decrypted.show ul.hidden {display:block;}
		#decoded-decrypted.show ul.hidden {display:block;}
		#decrypted-decoded.show ul.hidden {display:block;}
/*]]>*/</style>
	<script type="text/javascript">//<![CDATA[

// decrypts a string stored in a backup file
function decryptString( str )
{
	var outstr = "";
	for( var i = 0; i < str.length; ++i ){
		var chCode = 158 - ch;
		var ch = str.charCodeAt(i);
		var code = String.fromCharCode( 158 - ch );
		if( chCode < 0 || chCode > 255 || code == 'ยก' ){ // XXX: ยก char comes from a 1.0.x bug
			code = " ";// XXX: we got an invalid code going to guess and replace it with a space
		}
		outstr += code;
	}
	return outstr;
}
function encryptString( str )
{
	var encrypted = "";
	for( var i = 0; i < str.length; ++i ){
		encrypted += String.fromCharCode( 158 - str.charCodeAt(i) );
	}
	return encodeURI( encrypted );
}

function ID(id){ return document.getElementById( id ); }

function str2bytes( str )
{
	var bytes = [];
	for( var i = 0; i < str.length; ++i ){
		var ch = str.charCodeAt(i);
		bytes.push( ch );
	}
	return bytes;
}

function dumpBytes( str )
{
	var bytes = str2bytes( str );
	var output = "<ul class='hidden'>";
	for( var i = 0; i < bytes.length; ++i ){
		output +=  "<li>bytes["+ i + "] = '<b>" + bytes[i] + "</b>' = '<b>" + String.fromCharCode( bytes[i] ) + "</b>'</li>";
	}
	output += "</ul>";
	return output;
}

function toggleOutput( event )
{
	if( this.className == "show" ){
		this.className = "";
	}
	else{
		this.className = "show";
	}
}

function testDecryption( event )
{
	var input = ID('input-text');
	var decoded = decodeURI( input.value );
	var decrypted = decryptString( input.value );
	var output = ID("output-text");
	var decodedDecrypted = decryptString( decodeURI( input.value ) );
	var markup = "<div id='decoded'><h2>Decoded: " + decoded + "</h2>";
	markup += dumpBytes( decoded ) + "</div>";
	markup += "<div id='decrypted'><h2>Decrypted: " + decrypted + "</h2>";
	markup += dumpBytes( decrypted ) + "</div>";
	markup += "<div id='decoded-decrypted'><h2>Decoded &amp; Decrypted : " + decodedDecrypted + "</h2>";
	markup += dumpBytes( decodedDecrypted ) + "</div>";
	markup += "<div id='decrypted-decoded'><h2>Decrypted &amp; Decoded : " + decodeURI( decryptString( input.value ) ) + "</h2>";
	markup += dumpBytes( decodeURI( decryptString( input.value ) ) ) + "</div>";
	output.innerHTML = markup;

	ID('decoded').addEventListener( "click", toggleOutput, false );
	ID('decrypted').addEventListener( "click", toggleOutput, false );
	ID('decoded-decrypted').addEventListener( "click", toggleOutput, false );
	ID('decrypted-decoded').addEventListener( "click", toggleOutput, false );
}

function testEncryption( event )
{
	ID('encrypted-output').innerHTML = encryptString( ID('encrypt-text').value );
}

function init()
{
	ID('input-text').addEventListener( "input", testDecryption, false );
	ID('input-text').addEventListener( "change", testDecryption, false );
	ID('submit-text').addEventListener( "click", testDecryption, false );
	
	ID('encrypt-text').addEventListener( "input", testEncryption, false );
	ID('encrypt-text').addEventListener( "change", testEncryption, false );
	ID('encrypt-submit').addEventListener( "click", testEncryption, false );
}

window.onload = init;
	

//]]></script>
</head>
<body>
  This file does the informal encryption/decryption of individual xml fields in the backup file.
  Unrelated to when the user chooses a password to encrypt bakup files - 
	you need the full Simo client program to decrypt that.  
	<h1>Encryption</h1>
	paste in a text string to encrypt as in the backup file
	<h3>Input:</h3>
	<input id="encrypt-text" type="text"/><input id="encrypt-submit" type="button" value="Encrypt"/><br/>
	<h3>Output:</h3>
	<div style="width:50%;border:1px solid black;" id="encrypted-output"></div>
	<h1>Decryption</h1>
	paste in a text string from a backup file, the text between <b>[CDATA[</b> and <b>]]</b>
	<h3>Input:</h3>
	<input id="input-text" type="text"/><input id="submit-text" type="button" value="Decrypt"/><br/>
	<h3>Output:</h3>
	<div style="width:50%;border:1px solid black;" id="output-text"></div>
	<p>See also tools/dcryptfile.rb script
	<p>Warning: this encryption not to be used for security purposes; it's pretty easy to break.
</body>
</html>
